<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·ç§¯æ ¸ä½œç”¨æ¼”ç¤º - å¢å¼ºç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .canvas-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .canvas-wrapper {
            position: relative;
            margin: 10px 0;
        }
        canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: crosshair;
        }
        .pixel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            font-size: 8px;
            font-weight: bold;
        }
        .pixel-value {
            position: absolute;
            color: red;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .kernel-display {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .kernel-matrix {
            display: inline-grid;
            grid-template-columns: repeat(3, 60px);
            gap: 5px;
            margin: 10px 0;
        }
        .kernel-cell {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .description {
            margin: 15px 0;
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 5px;
        }
        .description h3 {
            margin-top: 0;
            color: #1976D2;
        }
        input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .info-box {
            margin: 10px 0;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
        }
        .pixel-detail {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
        .convolution-count {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="range"] {
            width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ å·ç§¯æ ¸ä½œç”¨æ¼”ç¤º - å¢å¼ºç‰ˆ</h1>
        
        <div class="controls">
            <input type="file" id="imageInput" accept="image/*">
            <button id="drawButton">ç»˜åˆ¶å›¾æ¡ˆ</button>
            <select id="kernelSelect">
                <option value="identity">åŸå›¾ï¼ˆå•ä½æ ¸ï¼‰</option>
                <option value="blur">æ¨¡ç³Š</option>
                <option value="sharpen">é”åŒ–</option>
                <option value="edge">è¾¹ç¼˜æ£€æµ‹</option>
                <option value="emboss">æµ®é›•æ•ˆæœ</option>
                <option value="sobel_x">Sobel Xï¼ˆå‚ç›´è¾¹ç¼˜ï¼‰</option>
                <option value="sobel_y">Sobel Yï¼ˆæ°´å¹³è¾¹ç¼˜ï¼‰</option>
            </select>
            <button id="applyButton" class="secondary">åº”ç”¨å·ç§¯ä¸€æ¬¡</button>
            <button id="resetButton" class="danger">é‡ç½®</button>
        </div>

        <div class="controls">
            <label>
                <input type="checkbox" id="showPixels">
                æ˜¾ç¤ºåƒç´ å€¼
            </label>
            <div class="size-control">
                <span>å›¾åƒå°ºå¯¸:</span>
                <input type="range" id="sizeSlider" min="10" max="30" value="20" step="5">
                <span id="sizeValue">20x20</span>
            </div>
        </div>

        <div class="info-box">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>é¼ æ ‡æ‚¬åœåœ¨å›¾åƒä¸Šå¯ä»¥æŸ¥çœ‹åƒç´ è¯¦æƒ…ã€‚å‹¾é€‰"æ˜¾ç¤ºåƒç´ å€¼"å¯ä»¥çœ‹åˆ°æ‰€æœ‰åƒç´ çš„æ•°å€¼ã€‚
        </div>

        <div class="convolution-count">
            å·ç§¯æ¬¡æ•°: <span id="countDisplay">0</span>
        </div>

        <div id="description" class="description"></div>

        <div class="kernel-display">
            <h3>å½“å‰å·ç§¯æ ¸ï¼š</h3>
            <div id="kernelMatrix" class="kernel-matrix"></div>
        </div>

        <div class="main-content">
            <div class="canvas-section">
                <h3>åŸå§‹å›¾åƒ</h3>
                <div class="canvas-wrapper">
                    <canvas id="originalCanvas"></canvas>
                    <div id="originalOverlay" class="pixel-overlay"></div>
                </div>
            </div>
            
            <div class="canvas-section">
                <h3>å¤„ç†åå›¾åƒï¼ˆå¯ç»§ç»­å·ç§¯ï¼‰</h3>
                <div class="canvas-wrapper">
                    <canvas id="resultCanvas"></canvas>
                    <div id="resultOverlay" class="pixel-overlay"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="pixelDetail" class="pixel-detail"></div>

    <script>
        let originalCanvas = document.getElementById('originalCanvas');
        let resultCanvas = document.getElementById('resultCanvas');
        let originalCtx = originalCanvas.getContext('2d');
        let resultCtx = resultCanvas.getContext('2d');
        const imageInput = document.getElementById('imageInput');
        const drawButton = document.getElementById('drawButton');
        const applyButton = document.getElementById('applyButton');
        const resetButton = document.getElementById('resetButton');
        const kernelSelect = document.getElementById('kernelSelect');
        const kernelMatrix = document.getElementById('kernelMatrix');
        const descriptionDiv = document.getElementById('description');
        const showPixelsCheckbox = document.getElementById('showPixels');
        const originalOverlay = document.getElementById('originalOverlay');
        const resultOverlay = document.getElementById('resultOverlay');
        const pixelDetail = document.getElementById('pixelDetail');
        const countDisplay = document.getElementById('countDisplay');
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValue = document.getElementById('sizeValue');

        let convolutionCount = 0;
        let gridSize = 20;
        let pixelSize = 15;
        let originalImageData = null;
        let userUploadedImage = null; // ä¿å­˜ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡

        // å®šä¹‰å„ç§å·ç§¯æ ¸
        const kernels = {
            identity: {
                matrix: [[0, 0, 0], [0, 1, 0], [0, 0, 0]],
                description: '<h3>å•ä½æ ¸ï¼ˆIdentityï¼‰</h3><p>è¿™ä¸ªå·ç§¯æ ¸ä¸ä¼šæ”¹å˜å›¾åƒï¼Œä¸­å¿ƒå€¼ä¸º1ï¼Œå…¶ä»–ä¸º0ã€‚è¾“å‡ºå›¾åƒä¸è¾“å…¥å›¾åƒå®Œå…¨ç›¸åŒã€‚</p>'
            },
            blur: {
                matrix: [[1/9, 1/9, 1/9], [1/9, 1/9, 1/9], [1/9, 1/9, 1/9]],
                description: '<h3>æ¨¡ç³Šæ ¸ï¼ˆBox Blurï¼‰</h3><p>å°†æ¯ä¸ªåƒç´ æ›¿æ¢ä¸ºå‘¨å›´9ä¸ªåƒç´ çš„å¹³å‡å€¼ï¼Œäº§ç”Ÿæ¨¡ç³Šæ•ˆæœã€‚æ‰€æœ‰å€¼ç›¸ç­‰ï¼Œæ€»å’Œä¸º1ã€‚</p>'
            },
            sharpen: {
                matrix: [[0, -1, 0], [-1, 5, -1], [0, -1, 0]],
                description: '<h3>é”åŒ–æ ¸ï¼ˆSharpenï¼‰</h3><p>å¢å¼ºå›¾åƒç»†èŠ‚ã€‚ä¸­å¿ƒå€¼è¾ƒå¤§ï¼ˆ5ï¼‰ï¼Œå‘¨å›´ä¸ºè´Ÿå€¼ï¼ˆ-1ï¼‰ï¼Œçªå‡ºåƒç´ ä¸å‘¨å›´çš„å·®å¼‚ã€‚</p>'
            },
            edge: {
                matrix: [[-1, -1, -1], [-1, 8, -1], [-1, -1, -1]],
                description: '<h3>è¾¹ç¼˜æ£€æµ‹æ ¸ï¼ˆEdge Detectionï¼‰</h3><p>æ£€æµ‹å›¾åƒä¸­çš„è¾¹ç¼˜ã€‚ä¸­å¿ƒå€¼ä¸º8ï¼Œå‘¨å›´å…¨æ˜¯-1ï¼Œåœ¨åƒç´ å€¼å˜åŒ–å¤§çš„åœ°æ–¹äº§ç”Ÿé«˜å“åº”ã€‚</p>'
            },
            emboss: {
                matrix: [[-2, -1, 0], [-1, 1, 1], [0, 1, 2]],
                description: '<h3>æµ®é›•æ ¸ï¼ˆEmbossï¼‰</h3><p>åˆ›å»º3Dæµ®é›•æ•ˆæœã€‚å·¦ä¸Šè§’ä¸ºè´Ÿå€¼ï¼Œå³ä¸‹è§’ä¸ºæ­£å€¼ï¼Œäº§ç”Ÿå…‰å½±å¯¹æ¯”ã€‚</p>'
            },
            sobel_x: {
                matrix: [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]],
                description: '<h3>Sobel Xæ ¸ï¼ˆå‚ç›´è¾¹ç¼˜ï¼‰</h3><p>æ£€æµ‹å‚ç›´æ–¹å‘çš„è¾¹ç¼˜ã€‚å·¦ä¾§ä¸ºè´Ÿå€¼ï¼Œå³ä¾§ä¸ºæ­£å€¼ï¼Œå¯¹æ°´å¹³æ–¹å‘çš„äº®åº¦å˜åŒ–æ•æ„Ÿã€‚</p>'
            },
            sobel_y: {
                matrix: [[-1, -2, -1], [0, 0, 0], [1, 2, 1]],
                description: '<h3>Sobel Yæ ¸ï¼ˆæ°´å¹³è¾¹ç¼˜ï¼‰</h3><p>æ£€æµ‹æ°´å¹³æ–¹å‘çš„è¾¹ç¼˜ã€‚ä¸Šæ–¹ä¸ºè´Ÿå€¼ï¼Œä¸‹æ–¹ä¸ºæ­£å€¼ï¼Œå¯¹å‚ç›´æ–¹å‘çš„äº®åº¦å˜åŒ–æ•æ„Ÿã€‚</p>'
            }
        };

        // åˆå§‹åŒ–ç”»å¸ƒå¤§å°
        function initCanvasSize() {
            const canvasWidth = gridSize * pixelSize;
            originalCanvas.width = canvasWidth;
            originalCanvas.height = canvasWidth;
            resultCanvas.width = canvasWidth;
            resultCanvas.height = canvasWidth;
            
            // æ›´æ–°overlayå°ºå¯¸
            originalOverlay.style.width = canvasWidth + 'px';
            originalOverlay.style.height = canvasWidth + 'px';
            resultOverlay.style.width = canvasWidth + 'px';
            resultOverlay.style.height = canvasWidth + 'px';
        }

        // ç»˜åˆ¶ç®€å•å›¾æ¡ˆ
        function drawPattern() {
            userUploadedImage = null; // æ¸…é™¤ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
            originalCtx.fillStyle = 'white';
            originalCtx.fillRect(0, 0, originalCanvas.width, originalCanvas.height);
            
            // ç»˜åˆ¶ä¸€äº›å‡ ä½•å›¾å½¢
            const size = gridSize * pixelSize;
            originalCtx.fillStyle = 'black';
            
            // æ­£æ–¹å½¢
            originalCtx.fillRect(size * 0.15, size * 0.15, size * 0.25, size * 0.25);
            
            // åœ†å½¢
            originalCtx.beginPath();
            originalCtx.arc(size * 0.65, size * 0.3, size * 0.12, 0, Math.PI * 2);
            originalCtx.fill();
            
            // çŸ©å½¢æ¡†
            originalCtx.strokeStyle = 'black';
            originalCtx.lineWidth = pixelSize * 0.3;
            originalCtx.strokeRect(size * 0.15, size * 0.55, size * 0.7, size * 0.3);
            
            saveOriginalImage();
            copyToResult();
            updatePixelDisplay();
        }

        // ä¿å­˜åŸå§‹å›¾åƒ
        function saveOriginalImage() {
            originalImageData = originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
        }

        // å¤åˆ¶åˆ°ç»“æœç”»å¸ƒ
        function copyToResult() {
            const imageData = originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
            resultCtx.putImageData(imageData, 0, 0);
            convolutionCount = 0;
            updateCount();
        }

        // æ˜¾ç¤ºå·ç§¯æ ¸çŸ©é˜µ
        function displayKernel(kernelName) {
            const kernel = kernels[kernelName];
            kernelMatrix.innerHTML = '';
            
            kernel.matrix.forEach(row => {
                row.forEach(value => {
                    const cell = document.createElement('div');
                    cell.className = 'kernel-cell';
                    cell.textContent = value.toFixed(2);
                    kernelMatrix.appendChild(cell);
                });
            });
            
            descriptionDiv.innerHTML = kernel.description;
        }

        // åº”ç”¨å·ç§¯ - åœ¨ç»“æœç”»å¸ƒä¸Šæ“ä½œ
        function applyConvolution() {
            const kernelName = kernelSelect.value;
            const kernel = kernels[kernelName].matrix;
            
            // ä»ç»“æœç”»å¸ƒè¯»å–æ•°æ®
            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const pixels = imageData.data;
            const output = resultCtx.createImageData(resultCanvas.width, resultCanvas.height);
            const width = resultCanvas.width;
            const height = resultCanvas.height;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let r = 0, g = 0, b = 0;
                    
                    // åº”ç”¨3x3å·ç§¯æ ¸
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIndex = ((y + ky) * width + (x + kx)) * 4;
                            const kernelValue = kernel[ky + 1][kx + 1];
                            
                            r += pixels[pixelIndex] * kernelValue;
                            g += pixels[pixelIndex + 1] * kernelValue;
                            b += pixels[pixelIndex + 2] * kernelValue;
                        }
                    }
                    
                    const outputIndex = (y * width + x) * 4;
                    output.data[outputIndex] = Math.min(255, Math.max(0, r));
                    output.data[outputIndex + 1] = Math.min(255, Math.max(0, g));
                    output.data[outputIndex + 2] = Math.min(255, Math.max(0, b));
                    output.data[outputIndex + 3] = 255;
                }
            }
            
            resultCtx.putImageData(output, 0, 0);
            convolutionCount++;
            updateCount();
            updatePixelDisplay();
        }

        // æ›´æ–°è®¡æ•°æ˜¾ç¤º
        function updateCount() {
            countDisplay.textContent = convolutionCount;
        }

        // æ˜¾ç¤ºåƒç´ å€¼
        function updatePixelDisplay() {
            if (!showPixelsCheckbox.checked) {
                originalOverlay.innerHTML = '';
                resultOverlay.innerHTML = '';
                return;
            }

            updateCanvasPixels(originalCanvas, originalOverlay);
            updateCanvasPixels(resultCanvas, resultOverlay);
        }

        function updateCanvasPixels(canvas, overlay) {
            overlay.innerHTML = '';
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            
            // åªæ˜¾ç¤ºç½‘æ ¼ç‚¹çš„åƒç´ å€¼
            for (let y = 0; y < canvas.height; y += pixelSize) {
                for (let x = 0; x < canvas.width; x += pixelSize) {
                    const index = (y * canvas.width + x) * 4;
                    const gray = Math.round((pixels[index] + pixels[index + 1] + pixels[index + 2]) / 3);
                    
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'pixel-value';
                    valueDiv.style.left = (x + pixelSize / 2 - 10) + 'px';
                    valueDiv.style.top = (y + pixelSize / 2 - 6) + 'px';
                    valueDiv.textContent = gray;
                    valueDiv.style.color = gray > 128 ? 'black' : 'white';
                    overlay.appendChild(valueDiv);
                }
            }
        }

        // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºåƒç´ è¯¦æƒ…
        function showPixelInfo(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor(e.clientX - rect.left);
            const y = Math.floor(e.clientY - rect.top);
            
            if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(x, y, 1, 1);
                const pixel = imageData.data;
                
                const gray = Math.round((pixel[0] + pixel[1] + pixel[2]) / 3);
                
                pixelDetail.style.display = 'block';
                pixelDetail.style.left = (e.clientX + 15) + 'px';
                pixelDetail.style.top = (e.clientY + 15) + 'px';
                pixelDetail.innerHTML = `
                    ä½ç½®: (${x}, ${y})<br>
                    RGB: (${pixel[0]}, ${pixel[1]}, ${pixel[2]})<br>
                    ç°åº¦å€¼: ${gray}
                `;
            }
        }

        // é‡ç½®
        function resetImage() {
            if (originalImageData) {
                originalCtx.putImageData(originalImageData, 0, 0);
                copyToResult();
                updatePixelDisplay();
            }
        }

        // åŠ è½½å›¾ç‰‡
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        userUploadedImage = img; // ä¿å­˜å›¾ç‰‡å¯¹è±¡
                        originalCtx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);
                        saveOriginalImage();
                        copyToResult();
                        updatePixelDisplay();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // äº‹ä»¶ç›‘å¬
        drawButton.addEventListener('click', drawPattern);
        applyButton.addEventListener('click', applyConvolution);
        resetButton.addEventListener('click', resetImage);
        kernelSelect.addEventListener('change', () => {
            displayKernel(kernelSelect.value);
        });
        showPixelsCheckbox.addEventListener('change', updatePixelDisplay);

        originalCanvas.addEventListener('mousemove', (e) => showPixelInfo(e, originalCanvas));
        resultCanvas.addEventListener('mousemove', (e) => showPixelInfo(e, resultCanvas));
        originalCanvas.addEventListener('mouseleave', () => pixelDetail.style.display = 'none');
        resultCanvas.addEventListener('mouseleave', () => pixelDetail.style.display = 'none');

        sizeSlider.addEventListener('input', (e) => {
            gridSize = parseInt(e.target.value);
            sizeValue.textContent = `${gridSize}x${gridSize}`;
            initCanvasSize();
            
            // å¦‚æœæœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œé‡æ–°ç»˜åˆ¶ç”¨æˆ·å›¾ç‰‡ï¼›å¦åˆ™ç»˜åˆ¶å‡ ä½•å›¾å½¢
            if (userUploadedImage) {
                originalCtx.drawImage(userUploadedImage, 0, 0, originalCanvas.width, originalCanvas.height);
                saveOriginalImage();
                copyToResult();
                updatePixelDisplay();
            } else {
                drawPattern();
            }
        });

        // åˆå§‹åŒ–
        initCanvasSize();
        displayKernel('identity');
        drawPattern();
    </script>
</body>
</html>